<Project>
  <PropertyGroup Condition="'$(AutoGenerateEntryPoint)' == 'true'">
    <!-- The location of the generated program file. For the moment we just support C#.-->
    <_GeneratedEntryPointFile>$(IntermediateOutputPath)$(MSBuildProjectName).Program.g.cs</_GeneratedEntryPointFile>
  </PropertyGroup>

  <Target Name="_GenerateRealEntryPointType"
          BeforeTargets="CoreCompile"
          DependsOnTargets="PrepareForBuild;CoreGenerateFunctionEntryPoint"
          Condition="'$(AutoGenerateEntryPoint)' == 'true'">
    <PropertyGroup>
      <StartupObject>AutoGeneratedProgram</StartupObject>
    </PropertyGroup>
  </Target>

  <Target Name="CoreGenerateFunctionEntryPoint"
          Condition="'$(Language)' == 'C#'"
          Inputs="$(MSBuildAllProjects)"
          Outputs="$(_GeneratedEntryPointFile)">

      <PropertyGroup>
         <_GeneratedProgramFileContent>

<![CDATA[
        // <auto-generated>This file was created automatically</auto-generated>
        using System.Runtime.CompilerServices;
        [CompilerGenerated]
        internal class AutoGeneratedProgram
        {
          public static void Main(string[] args) =>
              global::JonSkeet.DemoUtil.ApplicationChooser.Run(typeof(global::AutoGeneratedProgram), args);
        }
]]>

       </_GeneratedProgramFileContent>
    </PropertyGroup>
    <WriteLinesToFile File="$(_GeneratedEntryPointFile)"
                      Overwrite="true"
                      Lines="$([MSBuild]::Escape($(_GeneratedProgramFileContent)))"
                      Encoding="utf-8"/>

    <ItemGroup>
      <Compile Include="$(_GeneratedEntryPointFile)" />
    </ItemGroup>
  </Target>
</Project>
